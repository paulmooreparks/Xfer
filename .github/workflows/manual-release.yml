name: Manual NuGet/GitHub Publish

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g. 0.11.5-prerelease)'
        required: true
        type: string
      publish_to_nuget:
        description: 'Publish to NuGet?'
        required: true
        type: boolean
        default: true
      publish_to_github_packages:
        description: 'Publish to GitHub Packages?'
        required: true
        type: boolean
        default: true

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: nupkgs
        path: ./nupkgs

    - name: Publish to NuGet
      if: github.event.inputs.publish_to_nuget == 'true'
      run: |
        dotnet nuget push ./nupkgs/ParksComputing.Xfer.Lang.${{ github.event.inputs.version }}.nupkg \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate
        if [ -f ./nupkgs/ParksComputing.Xfer.Lang.${{ github.event.inputs.version }}.snupkg ]; then
          dotnet nuget push ./nupkgs/ParksComputing.Xfer.Lang.${{ github.event.inputs.version }}.snupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
        fi

    - name: Publish to GitHub Packages
      if: github.event.inputs.publish_to_github_packages == 'true'
      run: |
        dotnet nuget add source --username paulmooreparks --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/paulmooreparks/index.json"
        dotnet nuget push ./nupkgs/ParksComputing.Xfer.Lang.${{ github.event.inputs.version }}.nupkg --source "github" --skip-duplicate
        if [ -f ./nupkgs/ParksComputing.Xfer.Lang.${{ github.event.inputs.version }}.snupkg ]; then
          dotnet nuget push ./nupkgs/ParksComputing.Xfer.Lang.${{ github.event.inputs.version }}.snupkg --source "github" --skip-duplicate
        fi
